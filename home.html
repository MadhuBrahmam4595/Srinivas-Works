<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Proforma for Inspection of ITI's</title>
		<!-- Bootstrap CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
		<style>
			body{background:#f5f7fb;color:#222}
			.card{border-radius:12px;box-shadow:0 6px 20px rgba(21,32,43,0.08)}
			h1{font-size:18px;font-weight:700}
			.header-green{background:#198754;color:#fff;padding:8px 12px;border-radius:6px;display:inline-block}
			.form-label{font-weight:600}
			.small-note{font-size:13px;color:#6c757d}
			@media print{body{background:#fff} .card{box-shadow:none}}
		</style>
	</head>
	<body>
		<div class="container py-5">
			<div class="row justify-content-center">
				<div class="col-lg-10">
					<div class="card p-4">
						<div class="d-flex justify-content-between align-items-center mb-3">
							<h1 class="mb-0 header-green">PROFORMA FOR INSPECTION OF ITI'S</h1>
							<small class="text-muted">Printed: <span id="printedDate"></span></small>
						</div>

						<form id="inspectionForm" autocomplete="off" novalidate>
							<div class="row g-3 mb-2 align-items-center">
								<div class="col-md-4">
									<label for="rao_name" class="form-label">RAO Officer Name</label>
								</div>
								<div class="col-md-8">
									<div class="row g-2">
										<div class="col-sm-6">
											<input id="rao_name" name="rao_name" type="text" class="form-control" required>
											<div class="invalid-feedback">Please enter the RAO officer name.</div>
										</div>
										<div class="col-sm-6">
											<input id="rao_designation" name="rao_designation" title="rao_designation" type="text" class="form-control">
										</div>
									</div>
								</div>
							</div>

							<div class="row g-3 mb-2 align-items-center">
								<div class="col-md-4"><label for="inspection_date" class="form-label">Date of Inspection</label></div>
								<div class="col-md-8">
									<input id="inspection_date" name="inspection_date" type="date" class="form-control" required>
									<div class="invalid-feedback">Please provide a valid inspection date (not in the future).</div>
								</div>
							</div>

							<div class="row g-3 mb-2 align-items-center">
								<div class="col-md-4"><label for="iti_name" class="form-label">Name of the I.T.I.</label></div>
								<div class="col-md-8">
									<input id="iti_name" name="iti_name" type="text" class="form-control" required>
									<div class="invalid-feedback">Please enter the institute name.</div>
								</div>
							</div>

							<div class="row g-3 mb-2 align-items-center">
								<div class="col-md-4"><label for="head_name" class="form-label">Head of Institute (I/C)</label></div>
								<div class="col-md-8">
									<input id="head_name" name="head_name" type="text" class="form-control" required>
									<div class="invalid-feedback">Please enter the head of institute name.</div>
								</div>
							</div>

							<div class="row g-3 mb-2 align-items-start">
								<div class="col-md-4"><label for="postal_address" class="form-label">Postal Address</label></div>
								<div class="col-md-8">
									<textarea id="postal_address" name="postal_address" class="form-control" rows="2" required></textarea>
									<div class="invalid-feedback">Please enter the postal address.</div>
								</div>
							</div>

							<div class="row g-3 mb-2 align-items-center">
								<div class="col-md-4"><label for="landline" class="form-label">Land Line No.</label></div>
								<div class="col-md-8">
									<input id="landline" name="landline" type="tel" class="form-control" pattern="[0-9\-s]{6,15}">
									<div class="invalid-feedback">Enter a valid land-line (6-15 digits).</div>
								</div>
							</div>

							<div class="row g-3 mb-2 align-items-center">
								<div class="col-md-4"><label for="mobile" class="form-label">Mobile No.</label></div>
								<div class="col-md-8">
									<input id="mobile" name="mobile" type="tel" class="form-control" required >
									<div class="invalid-feedback">Enter a 10-digit mobile number (numbers only).</div>
								</div>
							</div>

							<div class="row g-3 mb-2 align-items-center">
								<div class="col-md-4"><label for="email" class="form-label">Eâ€‘Mail Address</label></div>
								<div class="col-md-8">
									<input id="email" name="email" type="email" class="form-control" required>
									<div class="invalid-feedback">Enter a valid email address.</div>
								</div>
							</div>

							<div class="row g-3 mb-3 align-items-start">
								<div class="col-md-4"><label for="remarks" class="form-label">Remarks / Notes</label></div>
								<div class="col-md-8">
									<textarea id="remarks" name="remarks" class="form-control" rows="3"></textarea>
								</div>
							</div>

							<!-- Trades & Units -->
							<div class="row g-3 mb-3 align-items-start">
								<div class="col-md-4"><label class="form-label">Trades & Units</label></div>
								<div class="col-md-8">
									<div id="tradeUnitsContainer"></div>
									<div class="mt-2">
										<button type="button" id="addTradeBtn" class="btn btn-sm btn-outline-primary">Add Trade</button>
										<span class="small text-muted ms-2">Shift: 1-3, Unit: 1-12</span>
									</div>
								</div>
							</div>

							<!-- Admissions: Admitted / Passed / Placed -->
							<div class="row g-3 mb-3 align-items-start">
								<div class="col-md-4"><label class="form-label">Details of Admissions, Passed & Placed (2023)</label></div>
								<div class="col-md-8">
									<div id="admissionsContainer"></div>
									<div class="mt-2">
										<button type="button" id="addAdmissionBtn" class="btn btn-sm btn-outline-primary">Add Row</button>
										<span class="small text-muted ms-2">Enter admitted / passed / placed counts</span>
									</div>
								</div>
							</div>

							<div class="d-flex justify-content-end">
								<button type="submit" id="saveBtn" class="btn btn-primary">Save</button>
							</div>
						</form>

						<div class="mt-3 small-note">Tip: Fields marked required must be filled. Data is saved locally in your browser when you save.</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Bootstrap JS (optional for components) -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			// show current date in header
			document.getElementById('printedDate').textContent = new Date().toLocaleDateString();

			// Set max date for inspection_date to today
			(function(){
				const dateInput = document.getElementById('inspection_date');
				if(dateInput){
					const today = new Date();
					const yyyy = today.getFullYear();
					const mm = String(today.getMonth()+1).padStart(2,'0');
					const dd = String(today.getDate()).padStart(2,'0');
					dateInput.max = yyyy + '-' + mm + '-' + dd;
				}
			})();

			// Live input: remove invalid when corrected
			const form = document.getElementById('inspectionForm');
			form.querySelectorAll('input,textarea').forEach(function(el){
				el.addEventListener('input', function(){ el.classList.remove('is-invalid'); });
			});

				// Trades UI helpers
				const tradeUnitsContainer = document.getElementById('tradeUnitsContainer');
				const addTradeBtn = document.getElementById('addTradeBtn');

				function createTradeRow(idx, data){
					const wrapper = document.createElement('div');
					wrapper.className = 'trade-unit-row d-flex gap-2 align-items-center mb-2';

					wrapper.innerHTML = `
						<div class="me-2" style="width:36px;text-align:right"><strong class="trade-index">${idx}</strong>.</div>
						<input type="text" class="form-control form-control-sm trade-name" placeholder="Trade name" style="flex:1" value="${data && data.tradeName ? escapeHtml(data.tradeName) : ''}">
						<select class="form-select form-select-sm trade-shift" style="width:90px">
							<option value="">Shift</option>
							<option value="1">1</option>
							<option value="2">2</option>
							<option value="3">3</option>
						</select>
						<select class="form-select form-select-sm trade-unit" style="width:110px">
							<option value="">Unit</option>
							${generateUnitOptions()}
						</select>
						<button type="button" class="btn btn-sm btn-outline-danger btn-remove">Remove</button>
					`;

					// set preselected values if provided
					if(data){
						if(data.shiftValue) wrapper.querySelector('.trade-shift').value = data.shiftValue;
						if(data.unitValue) wrapper.querySelector('.trade-unit').value = data.unitValue;
					}

					// remove handler
					wrapper.querySelector('.btn-remove').addEventListener('click', function(){
						wrapper.remove(); updateTradeIndices();
					});

					return wrapper;
				}

				function generateUnitOptions(){
					let opts = '';
					for(let i=1;i<=12;i++) opts += `<option value="${i}">${i}</option>`;
					return opts;
				}

				function updateTradeIndices(){
					const rows = tradeUnitsContainer.querySelectorAll('.trade-unit-row');
					rows.forEach((r,i)=>{ r.querySelector('.trade-index').textContent = i+1; });
				}

				function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

				addTradeBtn.addEventListener('click', function(){
					const row = createTradeRow(tradeUnitsContainer.children.length+1);
					tradeUnitsContainer.appendChild(row);
				});

				// add one initial empty row for convenience
				if(tradeUnitsContainer.children.length === 0){
					tradeUnitsContainer.appendChild(createTradeRow(1));
				}

					// Admissions UI helpers
					const admissionsContainer = document.getElementById('admissionsContainer');
					const addAdmissionBtn = document.getElementById('addAdmissionBtn');

					function createAdmissionRow(idx, data){
						const wrapper = document.createElement('div');
						wrapper.className = 'admission-row d-flex gap-2 align-items-center mb-2';

						wrapper.innerHTML = `
							<div class="me-2" style="width:36px;text-align:right"><strong class="admission-index">${idx}</strong>.</div>
							<input type="text" class="form-control form-control-sm admission-trade" placeholder="Trade name" style="flex:1" value="${data && data.trade ? escapeHtml(data.trade) : ''}">
							<input type="number" min="0" class="form-control form-control-sm admission-admitted" placeholder="Admitted" style="width:110px" value="${data && data.admitted != null ? data.admitted : ''}">
							<input type="number" min="0" class="form-control form-control-sm admission-passed" placeholder="Passed" style="width:110px" value="${data && data.passed != null ? data.passed : ''}">
							<input type="number" min="0" class="form-control form-control-sm admission-placed" placeholder="Placed" style="width:110px" value="${data && data.placed != null ? data.placed : ''}">
							<button type="button" class="btn btn-sm btn-outline-danger btn-remove-admission">Remove</button>
						`;

						wrapper.querySelector('.btn-remove-admission').addEventListener('click', function(){ wrapper.remove(); updateAdmissionIndices(); });

						return wrapper;
					}

					addAdmissionBtn.addEventListener('click', function(){
						const row = createAdmissionRow(admissionsContainer.children.length+1);
						admissionsContainer.appendChild(row);
					});

					// add one initial admission row for convenience
					if(admissionsContainer && admissionsContainer.children.length === 0){
						admissionsContainer.appendChild(createAdmissionRow(1));
					}

			// Main form submit handler
			const saveBtn = document.getElementById('saveBtn');
			form.addEventListener('submit', async function(e){
				e.preventDefault();
				let valid = true;
				const elements = Array.from(form.querySelectorAll('input,textarea'));
				elements.forEach(function(el){ el.classList.remove('is-invalid'); });

				// Basic validation
				elements.forEach(function(el){
					if(el.required && !el.value.trim()){
						el.classList.add('is-invalid');
						valid = false; 
						return;
					}
					if(el.type === 'email' && el.value){ 
						if(!el.checkValidity()){ 
							el.classList.add('is-invalid'); 
							valid = false; 
						}
					}
					if(el.pattern && el.value){ 
						var re = new RegExp('^'+el.getAttribute('pattern')+'$');
						if(!re.test(el.value)){
							el.classList.add('is-invalid'); 
							valid = false; 
						}
					}
				});

				// date not in future
				var dateEl = document.getElementById('inspection_date');
				if(dateEl && dateEl.value){ 
					var selected = new Date(dateEl.value); 
					var today = new Date(); today.setHours(0,0,0,0); 
					if(selected > today){ 
						dateEl.classList.add('is-invalid'); 
						valid = false; 
					}
				}

				if(!valid){ 
					var firstInvalid = form.querySelector('.is-invalid'); 
					if(firstInvalid) firstInvalid.focus(); 
					return; 
				}

				// Save to localStorage first
				var data = {};
				new FormData(form).forEach(function(v,k){ data[k]=v; });
				try{ localStorage.setItem('inspectionForm', JSON.stringify(data)); }catch(err){}

				// build payload
				var payload = {
					raoName: document.getElementById('rao_name').value.trim(),
					raoDesignation: document.getElementById('rao_designation').value.trim() || null,
					inspectionDate: document.getElementById('inspection_date').value,
					itiName: document.getElementById('iti_name').value.trim(),
					headName: document.getElementById('head_name').value.trim(),
					postalAddress: document.getElementById('postal_address').value.trim(),
					landline: document.getElementById('landline').value.trim() || null,
					mobile: document.getElementById('mobile').value.trim(),
					email: document.getElementById('email').value.trim(),
					remarks: document.getElementById('remarks').value.trim() || null,
					tradeUnits: [] // Initialize tradeUnits in the payload
				};

				// collect trade units from DOM
				const tradeUnits = [];
				document.querySelectorAll('.trade-unit-row').forEach(row => {
					const tnameEl = row.querySelector('.trade-name');
					const shiftEl = row.querySelector('.trade-shift');
					const unitEl = row.querySelector('.trade-unit');
					const tname = tnameEl ? tnameEl.value.trim() : '';
					const shift = shiftEl ? parseInt(shiftEl.value, 10) : null;
					const unit = unitEl ? parseInt(unitEl.value, 10) : null;
					tradeUnits.push({ tradeName: tname, shiftValue: shift, unitValue: unit });
				});
				payload.tradeUnits = tradeUnits;
					// collect admissions from DOM
					const admissions = [];
					document.querySelectorAll('.admission-row').forEach(row => {
						const tradeEl = row.querySelector('.admission-trade');
						const admittedEl = row.querySelector('.admission-admitted');
						const passedEl = row.querySelector('.admission-passed');
						const placedEl = row.querySelector('.admission-placed');
						const trade = tradeEl ? tradeEl.value.trim() : '';
						const admitted = admittedEl && admittedEl.value !== '' ? parseInt(admittedEl.value, 10) : null;
						const passed = passedEl && passedEl.value !== '' ? parseInt(passedEl.value, 10) : null;
						const placed = placedEl && placedEl.value !== '' ? parseInt(placedEl.value, 10) : null;
						admissions.push({ trade: trade, admitted: admitted, passed: passed, placed: placed });
					});
					payload.admissions = admissions;
				// disable UI while sending
				saveBtn.disabled = true;
				saveBtn.textContent = 'Saving...';

				try{
					var res = await fetch('http://localhost:8080/api/forms', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					if(!res.ok){
						var text = await res.text();
						alert('Save failed: ' + (text || res.statusText));
						return;
					}

					var saved = await res.json();
					alert('Saved successfully (id: ' + (saved.id || 'n/a') + ').');
				} catch(err){
					console.error(err);
					alert('Error saving form: ' + err.message);
				} finally {
					saveBtn.disabled = false;
					saveBtn.textContent = 'Save';
				}
			});
		</script>
	</body>
</html>
